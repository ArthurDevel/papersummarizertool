
# paperprocessor_v2 Plan

## Processing Pipeline

1. use Mistral OCR to get the markdown of each page. Insert <<page>> tags. For the images, we should convert to base64 and insert reference tags in the markdown so we can load them back in later. 

Base64 images are saved on the DTO together with their reference

The initial markdown is also stored on the DTO as ocr_markdown 

2. extract metadata
- title
- authors

3. extract structural elements
- headers
- tables
- images not needed

4. insert structural elements in markdown as << tags >>
each tag should contain the name of the structural element and the level

5. reformat headers to fit levels
so level 1 -> #
level 2 -> ## 
level 3 -> ###
etc

6. rewriting per section

## Code Structure

```
paperprocessor_v2/
├── client.py                    # Main public interface
├── models.py                    # DTOs and domain models
├── internals/
│   ├── __init__.py
│   ├── pdf_to_image.py          # PDF → images (reuse from v1)
│   ├── mistral_ocr.py           # Step 1: OCR each page to markdown
│   ├── metadata_extractor.py    # Step 2: Extract title/authors
│   ├── structure_extractor.py   # Step 3: Extract headers/tables
│   ├── structure_inserter.py    # Step 4: Insert << tags >> in markdown
│   ├── header_formatter.py      # Step 5: Reformat headers to # levels
│   └── section_rewriter.py      # Step 6: Rewrite sections
└── prompts/
    ├── extract_metadata.md
    ├── extract_structure.md
    ├── rewrite_section.md
    └── ...
```

## Key DTOs in `models.py`:

```python
@dataclass
class ProcessedImage:
    uuid: str                   # uuid4 field
    img_base64: str           # base64 string of the image
    page_number: int           # on which page it occurs

@dataclass
class Header:
    text: str                 # header text
    level: int                 # header level (1, 2, 3, etc.)
    page_number: int           # which page it appears on

@dataclass
class ProcessedPage:
    page_number: int
    ocr_markdown: str           # Raw OCR markdown
    structured_markdown: str    # With << tags >>
    images: List[ProcessedImage]     # Images on this page

@dataclass
class ProcessedDocument:
    title: Optional[str]
    authors: Optional[str]
    pdf_base64: str            # base64 encoded version of the pdf
    pages: List[ProcessedPage]
    headers: List[Header]       # Document headers
    final_markdown: str         # Fully processed output
```

## `client.py` Main Interface:

```python
async def process_paper_pdf(pdf_contents: bytes, paper_id: str = None) -> ProcessedDocument:
    """
    6-step pipeline:
    1. OCR → markdown per page
    2. Extract metadata  
    3. Extract structural elements
    4. Insert << tags >>
    5. Format headers
    6. Rewrite sections
    """
```




